<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>William Rooms - Pro Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --sent: #6366f1;
            --received: #f1f5f9;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--bg); color: var(--text); line-height: 1.6; overflow: hidden; }

        .container { max-width: 500px; margin: 0 auto; height: 100vh; position: relative; background: var(--bg); display: flex; flex-direction: column; }

        /* Screens Management */
        .screen { display: none; height: 100%; flex-direction: column; animation: fadeIn 0.3s ease; padding: 20px; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Elements */
        .card { background: var(--card); border-radius: 20px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1 { color: var(--primary); text-align: center; font-size: 28px; margin-bottom: 20px; font-weight: 700; }
        h3 { margin-bottom: 15px; font-size: 18px; color: var(--text); }

        input { width: 100%; padding: 14px 18px; border-radius: 15px; border: 1.5px solid #e2e8f0; background: #fff; color: var(--text); margin-bottom: 12px; font-size: 16px; transition: 0.3s; outline: none; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        .btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 15px; cursor: pointer; font-weight: 700; width: 100%; font-size: 16px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.96); }
        .btn-secondary { background: #64748b; }
        .btn-outline { background: transparent; color: var(--danger); border: 1px solid var(--danger); padding: 8px 15px; font-size: 13px; width: auto; }

        /* Header */
        .header { display: flex; align-items: center; justify-content: space-between; padding: 10px 0 20px 0; border-bottom: 1px solid #e2e8f0; margin-bottom: 15px; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 40px; height: 40px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }

        /* Rooms List */
        #roomsList { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .room-item { background: var(--card); padding: 18px; border-radius: 18px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-right: 4px solid var(--primary); transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .room-item:active { transform: scale(0.98); background: #f1f5f9; }

        /* Chat Screen */
        .chat-header { display: flex; align-items: center; gap: 15px; padding: 10px 20px; background: var(--card); box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: absolute; top: 0; left: 0; right: 0; z-index: 10; height: 70px; }
        .messages { flex: 1; overflow-y: auto; padding: 80px 20px 90px 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; position: relative; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .msg.sent { align-self: flex-start; background: var(--sent); color: white; border-bottom-right-radius: 4px; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.2); }
        .msg.received { align-self: flex-end; background: var(--received); color: var(--text); border-bottom-left-radius: 4px; }
        
        .msg-info { display: flex; align-items: center; justify-content: flex-end; gap: 4px; font-size: 10px; margin-top: 5px; opacity: 0.8; }
        .seen-tick { color: #38bdf8; font-weight: bold; }

        /* Input Area */
        .input-area { position: absolute; bottom: 0; left: 0; right: 0; padding: 15px 20px; background: var(--card); display: flex; gap: 10px; align-items: center; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        .input-area input { margin-bottom: 0; border-radius: 30px; padding: 12px 20px; background: #f1f5f9; border: none; }
        .send-btn { width: 48px; height: 48px; border-radius: 50%; background: var(--primary); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); }

        /* Utils */
        .loader { text-align: center; padding: 20px; color: var(--text-light); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-light); }
    </style>
</head>
<body>

<div class="container">
    <div id="loginScreen" class="screen active">
        <div style="margin-top: 40px;">
            <h1>William Rooms</h1>
            <p style="text-align: center; color: var(--text-light); margin-bottom: 30px;">ØªÙˆØ§ØµÙ„ Ø¨Ø®ØµÙˆØµÙŠØ© ØªØ§Ù…Ø©</p>
            <div class="card">
                <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn" onclick="signIn()">Ø¯Ø®ÙˆÙ„</button>
                <div style="height: 10px;"></div>
                <button class="btn btn-secondary" onclick="signUp()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>
    </div>

    <div id="mainScreen" class="screen">
        <div class="header">
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div>
                    <strong id="userName">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</strong>
                    <p style="font-size: 11px; color: var(--text-light);">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</p>
                </div>
            </div>
            <button class="btn-outline" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        </div>

        <div class="card">
            <h3>Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø§Ù†Ø¶Ù…Ø§Ù…</h3>
            <input type="text" id="roomName" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© (Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡)">
            <input type="text" id="roomCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (Ù…Ø«Ø§Ù„: WK2024)">
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="createRoom()" style="flex: 1;">Ø¥Ù†Ø´Ø§Ø¡</button>
                <button class="btn" onclick="joinRoom()" style="flex: 1; background: var(--success);">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
            </div>
        </div>

        <h3>ØºØ±ÙÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
        <div id="roomsList">
            <div class="loader">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù...</div>
        </div>
    </div>

    <div id="chatScreen" class="screen" style="padding: 0;">
        <div class="chat-header">
            <button onclick="closeChat()" style="background:none; border:none; font-size: 24px; cursor:pointer;">ğŸ”™</button>
            <div class="avatar" id="chatAvatar" style="width:35px; height:35px; font-size: 14px;">G</div>
            <div style="flex: 1;">
                <strong id="chatTitle" style="font-size: 16px;">Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©</strong>
                <p id="roomStatus" style="font-size: 11px; color: var(--text-light);">Ù†Ø´Ø·</p>
            </div>
        </div>
        
        <div class="messages" id="messagesBox"></div>
        
        <div class="input-area">
            <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." autocomplete="off">
            <button class="send-btn" onclick="sendMsg()">â¤</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ)
    const firebaseConfig = {
        apiKey: "AIzaSyCYpL7ANTarOfbjudlur53Gxax-X2BZm1M",
        authDomain: "private-space-aad2a.firebaseapp.com",
        projectId: "private-space-aad2a",
        storageBucket: "private-space-aad2a.firebasestorage.app",
        messagingSenderId: "59667950205",
        appId: "1:59667950205:web:05511e2ce4606a01ecdf14"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let currentRoomId = null;
    let messagesListener = null;

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ø´Ø§Øª ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id + 'Screen').classList.add('active');
    }

    // --- Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ---
    function signUp() {
        const e = document.getElementById('email').value, p = document.getElementById('password').value;
        if(!e || !p) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        auth.createUserWithEmailAndPassword(e, p).catch(err => alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + err.message));
    }

    function signIn() {
        const e = document.getElementById('email').value, p = document.getElementById('password').value;
        if(!e || !p) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        auth.signInWithEmailAndPassword(e, p).catch(err => alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + err.message));
    }

    function logout() { auth.signOut(); }

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            const name = user.email.split('@')[0];
            document.getElementById('userName').textContent = name;
            document.getElementById('userAvatar').textContent = name[0].toUpperCase();
            showScreen('main');
            loadRooms();
        } else {
            showScreen('login');
        }
    });

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±Ù ---
    function createRoom() {
        const name = document.getElementById('roomName').value;
        const code = document.getElementById('roomCode').value.toUpperCase();
        if(!name || !code) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©");

        db.collection('rooms').add({
            name, code,
            members: [currentUser.uid],
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            document.getElementById('roomName').value = '';
            document.getElementById('roomCode').value = '';
        });
    }

    function joinRoom() {
        const code = document.getElementById('roomCode').value.toUpperCase();
        if(!code) return alert("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…");

        db.collection('rooms').where('code', '==', code).get().then(snap => {
            if(snap.empty) return alert("Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
            snap.docs[0].ref.update({
                members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
            }).then(() => {
                document.getElementById('roomCode').value = '';
            });
        });
    }

    function loadRooms() {
        db.collection('rooms').where('members', 'array-contains', currentUser.uid).onSnapshot(snap => {
            const list = document.getElementById('roomsList');
            list.innerHTML = '';
            if(snap.empty) {
                list.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±Ù Ø­Ø§Ù„ÙŠØ§Ù‹.<br>Ø£Ù†Ø´Ø¦ ØºØ±ÙØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø§Ù„Ø¢Ù†!</div>';
                return;
            }
            snap.forEach(doc => {
                const room = doc.data();
                const div = document.createElement('div');
                div.className = 'room-item';
                div.innerHTML = `
                    <div>
                        <strong>${room.name}</strong>
                        <p style="font-size:12px; color:gray;">ÙƒÙˆØ¯: ${room.code}</p>
                    </div>
                    <span style="font-size:12px;">Ø¯Ø®ÙˆÙ„ â†</span>
                `;
                div.onclick = () => openChat(doc.id, room.name);
                list.appendChild(div);
            });
        });
    }

    // --- Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
    function openChat(id, name) {
        currentRoomId = id;
        document.getElementById('chatTitle').textContent = name;
        document.getElementById('chatAvatar').textContent = name[0].toUpperCase();
        showScreen('chat');
        loadMessages(id);
    }

    function closeChat() {
        if(messagesListener) messagesListener(); // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
        showScreen('main');
    }

    function loadMessages(roomId) {
        const box = document.getElementById('messagesBox');
        messagesListener = db.collection('rooms').doc(roomId).collection('messages')
            .orderBy('time', 'asc')
            .onSnapshot(snap => {
                box.innerHTML = '';
                snap.forEach(doc => {
                    const m = doc.data();
                    const isMe = m.sender === currentUser.uid;
                    const date = m.time ? m.time.toDate() : new Date();
                    const timeStr = date.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});

                    // ØªØ­Ø¯ÙŠØ« "ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©" Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
                    if(!isMe && !m.seen) {
                        doc.ref.update({ seen: true });
                    }

                    const msgDiv = document.createElement('div');
                    msgDiv.className = `msg ${isMe ? 'sent' : 'received'}`;
                    msgDiv.innerHTML = `
                        ${m.text}
                        <div class="msg-info">
                            <span>${timeStr}</span>
                            ${isMe ? `<span class="seen-tick">${m.seen ? 'âœ”ï¸âœ”ï¸' : 'âœ”ï¸'}</span>` : ''}
                        </div>
                    `;
                    box.appendChild(msgDiv);
                });
                box.scrollTop = box.scrollHeight;
            });
    }

    function sendMsg() {
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if(!text || !currentRoomId) return;

        db.collection('rooms').doc(currentRoomId).collection('messages').add({
            text: text,
            sender: currentUser.uid,
            senderEmail: currentUser.email,
            time: firebase.firestore.FieldValue.serverTimestamp(),
            seen: false
        });
        input.value = '';
        input.focus();
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
    document.getElementById('msgInput').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') sendMsg();
    });
</script>

</body>
</html>
